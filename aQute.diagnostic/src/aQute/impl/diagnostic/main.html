<html>
<body>
	<br />
	<div id="b">
	</div>
	
	<svg id="a" style="width:1500px;height:1500px" class="chart">
	</svg>
	<script src="http://d3js.org/d3.v2.js"></script>
	<script type="text/javascript">
		var locations = {}
		var x = 0;
		var y = 0;

		function loc(d) {
			var p = locations[d.id];
			if (!p) {
				if (x > 10) {
					x = 0;
					y++;
				} else
					x++

				p = {}
				p.x = x;
				p.y = y;
				locations[d.id] = p;
			}
			return p;
		}
		
	   function log(log) {
		   if (!log)
			   return "Empty";
		   
		  log = log.reverse();
		  var n =5;
		  var l = []
		  for ( var i=0; i<5; i++)
			  if ( log[i])
				  l[i]=log[i].message;
		  
		  return l.join("\n");
	   }
	   
	   
		function timer() {
			d3.json("diagnostics/state.json", function(state) {
				if ( state) {
					var bundles = d3.select("#a").selectAll("g")
						.data(state.bundles, function(d) { return d.id; });
						
					var newbundles =
						bundles.enter()
							.append("g")
				    		.attr("transform", function(d, i) { return "translate(" + 10 + "," + (i*30) + ")"; });
					
							
					newbundles.append("rect")
					    .attr("width", 120)
					    .attr("height", 25);
				
					newbundles
						.append("a")
					    .attr("xlink:href", "logs")				
						.append("circle")
						    .attr("cx", 100)
						    .attr("cy", 12)
						    .attr("r", 5)
						    .append("title");
					
				
					newbundles.append("text")
						.attr("class","bar")
						.attr("dy", 10)
						.attr("dx", 4)
					    .text(function(d) {return d.handle});
	
					bundles.exit().remove();
					    
					bundles.select("rect")
						.attr("class", function(d) {return d.state})
				
					bundles.select("circle")
						.attr("class", function(d) { return d.alert ? d.alert : "LOG_UNKNOWN"; })
						.select("title").text(function(d) { return log(d.log); });
					
				}
				setTimeout(timer,5000)
			})
		}
		
		timer();
			
	</script>
</body>
</html>
