<html>
<body>
	<br />
	<svg version="1.1" xmlns="http://www.w3.org/2000/svg"
		xmlns:xl="http://www.w3.org/1999/xlink" id="state" width="1000"
		height="1000">
		<defs>
	        <circle id="get" cx="0" cy="0" r="5" fill="yellow"
				stroke="black" stroke-width="1" />
	        <rect id="bundle" x="-50" y="-20" ry="10" rx="10" width="60" height="40" />
	    </defs>
	</svg>
	
	<script src="http://d3js.org/d3.v2.js"></script>
	<script type="text/javascript">

		var color = d3.scale.category20();
		var force = d3.layout.force().gravity(0).charge(-500).linkDistance(30).size(
				[ 1000, 1000 ]);

		var svg = d3.select("#state");

		function timer() {
			d3.json("diagnostics/stategraph.json", function(json) {
				
				var nodes = json.nodes;
				var links = json.links;
				
	/* 			links = [{"id":"b0->org.osgi.service.packageadmin.PackageAdmin","source":0,"target":1}, {"id":"b0->org.osgi.service.packageadmin.PackageAdmin","source":1,"target":2}]
				nodes = [	{"id":"org.apache.felix.shell.Command","index":0,"name":"Command","title":"org.apache.felix.shell.Command","type":"get"},
				         	{"id":"org.osgi.service.packageadmin.PackageAdmin","index":1,"name":"PackageAdmin","title":"org.osgi.service.packageadmin.PackageAdmin","type":"get"}, 
				         	{"id":"b4","index":2,"name":"? Shell TUI","title":"org.apache.felix.shell.tui","type":"bundle"}]
	 */			
				force.nodes(nodes).links(links).theta(2).charge(-300).linkDistance(50).start();
	
				var link = svg.selectAll(".link").data(links, function(d) { return d.id;})
				
				link.enter()
					.append("line")
						.attr("class", "link")
		
				link.exit().remove()
	
				
				var node = svg.selectAll(".node")
					.data(nodes, function(d) { return d.id;})
					.enter()
					.append("g")
						.attr("class", "node")
						.call(force.drag)
						
				node.append("use")
					.attr("xlink:href", function (d) { return "#"+d.type; })
				
				node.append("text")
					.attr("class", "title")
					.attr("x", 0)
					.attr("y", 0)
					.text(function(d) { return d.name; })
					
				node.append("title").text(function(d) {
					return d.title;
				});
				
				svg.selectAll("use").attr("class", function (d) { return d.state; })
				
				force.on("tick", function() {
					link.attr("x1", function(d) {
						return d.source.x;
					}).attr("y1", function(d) {
						return d.source.y;
					}).attr("x2", function(d) {
						return d.target.x;
					}).attr("y2", function(d) {
						return d.target.y;
					});
	
					node.attr("transform", function(d) {
						return "translate("+(d.x)+","+(d.y)+")";
					});
				});
	
			});
		}
		setInterval("timer()", 2000);
	</script>
</body>
</html>
